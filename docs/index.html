<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Free Choropleth Tool - Create Data Maps from ANY CSV File</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="zip_detection.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --sidebar-bg: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            --text-color: white;
            --control-bg: #2a2a2a;
            --border-color: #444;
            --hover-bg: #333;
            --message-bg: #1a1a1a;
            --accent-color: #00d4ff;
            --success-color: #4caf50;
            --error-color: #ff6b6b;
            --warning-color: #ffa726;
        }
        
        body.light-theme {
            --sidebar-bg: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            --text-color: #212529;
            --control-bg: white;
            --border-color: #dee2e6;
            --hover-bg: #f8f9fa;
            --message-bg: white;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            background: #0a0a0a;
        }
        
        body.light-theme { background: #f0f0f0; }
        
        .sidebar {
            width: 450px;
            background: var(--sidebar-bg);
            color: var(--text-color);
            padding: 25px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7a5cff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 25px;
            line-height: 1.4;
        }
        
        /* CSV Analysis Panel */
        .analysis-panel {
            background: rgba(0, 212, 255, 0.1);
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .analysis-panel h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .analysis-item {
            margin: 12px 0;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .analysis-item:hover {
            background: rgba(0, 212, 255, 0.2);
            transform: translateX(5px);
        }
        
        .analysis-item.recommended {
            border: 2px solid var(--success-color);
            background: rgba(76, 175, 80, 0.1);
        }
        
        .analysis-label {
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 4px;
        }
        
        .analysis-detail {
            font-size: 0.85em;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .sample-values {
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
            color: var(--warning-color);
        }
        
        /* Controls */
        .control-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-color);
        }
        
        .help-text {
            font-size: 0.85em;
            opacity: 0.7;
            font-weight: normal;
            text-transform: none;
            letter-spacing: 0;
            margin-top: 4px;
        }
        
        select {
            width: 100%;
            padding: 12px;
            background: var(--control-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        select:hover { border-color: var(--accent-color); }
        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }
        
        /* Column grid */
        .column-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .column-item {
            padding: 12px;
            background: var(--control-bg);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.9em;
        }
        
        .column-item:hover {
            background: var(--hover-bg);
            border-color: var(--accent-color);
        }
        
        .column-item.selected {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(122, 92, 255, 0.2));
            border-color: var(--accent-color);
        }
        
        /* Upload zone */
        .upload-zone {
            border: 3px dashed var(--border-color);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
            background: var(--control-bg);
        }
        
        .upload-zone:hover {
            border-color: var(--accent-color);
            background: var(--hover-bg);
        }
        
        .upload-zone.has-file {
            border-color: var(--success-color);
            background: rgba(76, 175, 80, 0.05);
        }
        
        .upload-icon { font-size: 3em; margin-bottom: 15px; }
        
        /* Button */
        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, #00d4ff, #7a5cff);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Export button */
        .export-btn {
            margin-top: 10px;
            background: linear-gradient(90deg, #4caf50, #45a049);
        }
        
        /* Theme toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .theme-btn {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .theme-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: var(--accent-color);
        }
        
        /* Basemap selector */
        .basemap-selector {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
        }
        
        .basemap-selector label {
            color: white;
            font-size: 0.85em;
            margin-bottom: 5px;
            display: block;
        }
        
        /* Map container */
        #map {
            flex: 1;
            background: #0a0a0a;
        }
        
        /* Legend */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(26, 26, 26, 0.95);
            padding: 20px;
            border-radius: 8px;
            color: white;
            min-width: 200px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        
        .legend h3 {
            margin-bottom: 15px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-color);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 0.85em;
        }
        
        .legend-color {
            width: 25px;
            height: 25px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9em;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .message.success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .message.error {
            background: rgba(255, 107, 107, 0.1);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
        
        .message.info {
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            border: 1px solid #60a5fa;
        }
        
        .message.warning {
            background: rgba(255, 167, 38, 0.1);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }
        
        /* Help section */
        .help-section {
            background: var(--control-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .help-section h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .help-section ul {
            list-style: none;
            padding: 0;
        }
        
        .help-section li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .help-section li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: var(--accent-color);
        }
        
        /* Sample data links */
        .sample-data {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .sample-data a {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 0.85em;
            margin-right: 15px;
        }
        
        .sample-data a:hover { text-decoration: underline; }
        
        /* Stats box */
        .stats-box {
            background: var(--message-bg);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.9em;
        }
        
        .stat-label { opacity: 0.7; }
        .stat-value {
            color: var(--accent-color);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>🗺️ Choropleth Tool</h1>
        <p class="subtitle">Transform ANY CSV data into beautiful choropleth maps instantly. No expensive GIS software needed - 100% free and browser-based.</p>
        
        <div class="help-section">
            <h3>📚 Quick Start Guide</h3>
            <ul>
                <li>Upload ANY CSV file with geographic data</li>
                <li>We'll analyze it and suggest the best settings</li>
                <li>Select which data to visualize on the map</li>
                <li>Export to use in ArcGIS or other tools</li>
            </ul>
        </div>
        
        <div class="upload-zone" id="dropZone">
            <input type="file" id="csvFile" accept=".csv" hidden />
            <div class="upload-icon">📊</div>
            <p style="font-size: 1.1em; margin-bottom: 10px; font-weight: 600;">Drop CSV here</p>
            <p style="opacity: 0.7; font-size: 0.9em;">or click to browse</p>
        </div>
        
        <div class="sample-data">
            <a href="test_data/midwest_states_agriculture.csv" download>📥 States Example</a>
            <a href="test_data/texas_counties_population.csv" download>📥 Counties Example</a>
            <a href="test_data/florida_zips_poverty.csv" download>📥 ZIP Codes Example</a>
        </div>
        
        <div id="analysisPanel" class="analysis-panel">
            <h3>🔍 CSV Analysis & Recommendations</h3>
            <div id="analysisContent"></div>
        </div>
        
        <div id="controlsContainer" style="display: none;">
            <div class="control-group">
                <label>
                    Map Title (Optional)
                    <div class="help-text">Give your map a descriptive title</div>
                </label>
                <input type="text" id="mapTitle" placeholder="e.g., Midwest Agricultural Production by State" 
                       style="width: 100%; padding: 12px; background: var(--control-bg); 
                              border: 1px solid var(--border-color); border-radius: 8px; 
                              color: var(--text-color); font-size: 1em;">
            </div>
            
            <div class="control-group">
                <label>
                    Geographic Level
                    <div class="help-text" id="geoLevelHelp">What type of boundaries does your data represent?</div>
                </label>
                <select id="geoLevel">
                    <option value="">Select level...</option>
                    <optgroup label="States & Counties">
                        <option value="us_states">US States (2-digit FIPS)</option>
                        <option value="us_counties">US Counties (5-digit FIPS)</option>
                    </optgroup>
                    <optgroup label="ZIP Codes by Region">
                        <option value="zctas_northeast">Northeast ZIP Codes (6,000+ ZIPs)</option>
                        <option value="zctas_southeast">Southeast ZIP Codes (7,700+ ZIPs)</option>
                        <option value="zctas_midwest">Midwest ZIP Codes (10,000+ ZIPs)</option>
                        <option value="zctas_south">South ZIP Codes (3,800+ ZIPs)</option>
                        <option value="zctas_west">West ZIP Codes (5,400+ ZIPs)</option>
                    </optgroup>
                    <optgroup label="ZIP Codes by State">
                        <option value="zctas_fl">Florida ZIP Codes</option>
                        <option value="zctas_tx">Texas ZIP Codes</option>
                        <option value="zctas_ca">California ZIP Codes</option>
                        <option value="zctas_ny">New York ZIP Codes</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="control-group">
                <label>
                    Boundary Quality
                    <div class="help-text">Choose between fast loading or high quality for ArcGIS export</div>
                </label>
                <div style="display: flex; gap: 10px;">
                    <label style="flex: 1; padding: 10px; background: var(--control-bg); border-radius: 8px; 
                                  border: 2px solid var(--border-color); cursor: pointer; text-align: center;">
                        <input type="radio" name="quality" value="fast" checked> 
                        ⚡ Fast (smaller files)
                    </label>
                    <label style="flex: 1; padding: 10px; background: var(--control-bg); border-radius: 8px; 
                                  border: 2px solid var(--border-color); cursor: pointer; text-align: center;">
                        <input type="radio" name="quality" value="hq"> 
                        ✨ High Quality (for ArcGIS)
                    </label>
                </div>
            </div>
            
            <div class="control-group">
                <label>
                    Geographic ID Column
                    <div class="help-text" id="joinColumnHelp">Which column contains your geographic identifiers?</div>
                </label>
                <select id="joinColumn">
                    <option value="">Select column...</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>
                    Data to Visualize
                    <div class="help-text">Select a numeric column to create your choropleth map</div>
                </label>
                <div class="column-grid" id="dataColumns"></div>
            </div>
            
            <div class="control-group">
                <label>
                    Data Units (Optional)
                    <div class="help-text">What units does your data represent?</div>
                </label>
                <input type="text" id="dataUnits" placeholder="e.g., millions of acres, %, dollars" 
                       style="width: 100%; padding: 12px; background: var(--control-bg); 
                              border: 1px solid var(--border-color); border-radius: 8px; 
                              color: var(--text-color); font-size: 1em;">
            </div>
            
            <button class="btn-primary" id="createMapBtn" disabled>
                🚀 Create Map
            </button>
            
            <button class="btn-primary export-btn" id="exportBtn" style="display: none;">
                📥 Export to ArcGIS
            </button>
            
            <div id="statsBox" class="stats-box" style="display: none;">
                <div class="stat-row">
                    <span class="stat-label">Features:</span>
                    <span class="stat-value" id="statFeatures">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Matched:</span>
                    <span class="stat-value" id="statMatched">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Range:</span>
                    <span class="stat-value" id="statRange">-</span>
                </div>
            </div>
        </div>
        
        <div id="messageContainer"></div>
    </div>
    
    <div id="map"></div>
    
    <!-- Map controls -->
    <div class="theme-toggle">
        <button class="theme-btn" onclick="toggleTheme()">🌓 Theme</button>
    </div>
    
    <div class="basemap-selector">
        <label>Basemap Style</label>
        <select id="basemapSelect" onchange="changeBasemap()">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
            <option value="osm">Streets</option>
            <option value="satellite">Satellite</option>
            <option value="topo">Topographic</option>
        </select>
    </div>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([39.8, -98.5], 4);
        
        // Basemap options
        const basemaps = {
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
                attribution: '© CARTO',
                maxZoom: 19
            }),
            light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: '© CARTO',
                maxZoom: 19
            }),
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© ESRI',
                maxZoom: 19
            }),
            topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenTopoMap',
                maxZoom: 17
            })
        };
        
        // Set initial basemap
        let currentBasemap = basemaps.dark;
        currentBasemap.addTo(map);
        
        // Global variables
        let csvData = null;
        let boundaries = {};
        let currentLayer = null;
        let currentLegend = null;
        let metadata = null;
        let selectedDataColumn = null;
        let csvLookup = {};
        let currentGeoJSON = null;
        
        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            if (document.body.classList.contains('light-theme')) {
                changeBasemap('light');
                document.getElementById('basemapSelect').value = 'light';
            } else {
                changeBasemap('dark');
                document.getElementById('basemapSelect').value = 'dark';
            }
        }
        
        // Change basemap
        function changeBasemap(style) {
            const selectedStyle = style || document.getElementById('basemapSelect').value;
            if (currentBasemap) {
                map.removeLayer(currentBasemap);
            }
            currentBasemap = basemaps[selectedStyle];
            currentBasemap.addTo(map);
        }
        
        // Load metadata on startup
        async function loadMetadata() {
            try {
                // Load all metadata files
                const [fastResponse, hqResponse, regionalResponse] = await Promise.all([
                    fetch('boundaries/metadata.json'),
                    fetch('boundaries_hq/metadata.json').catch(() => null),
                    fetch('boundaries_regional/metadata.json').catch(() => null)
                ]);
                
                metadata = await fastResponse.json();
                
                // Add high quality metadata if available
                if (hqResponse) {
                    const hqMetadata = await hqResponse.json();
                    metadata.hq = hqMetadata;
                }
                
                // Add regional boundaries metadata (regional ZIP codes)
                if (regionalResponse) {
                    const regionalMetadata = await regionalResponse.json();
                    // Merge regional boundaries into main metadata
                    Object.assign(metadata.boundaries, regionalMetadata.boundaries);
                }
                
                showMessage('Ready! Upload any CSV file. ZIP codes organized by region for better performance!', 'info');
            } catch (error) {
                showMessage('Error loading boundary data. Please refresh the page.', 'error');
            }
        }
        
        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('csvFile');
        
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#00d4ff';
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = '';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '';
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                processCSV(file);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processCSV(file);
        });
        
        // Analyze CSV to provide smart recommendations
        function analyzeCSV(data, columns) {
            const analysis = {
                geographicLevel: null,
                geoColumn: null,
                dataColumns: [],
                warnings: [],
                recommendations: []
            };
            
            // Sample first 10 rows for analysis
            const sample = data.slice(0, Math.min(10, data.length));
            
            // Analyze each column
            columns.forEach(col => {
                const colLower = col.toLowerCase();
                const values = sample.map(row => row[col]).filter(v => v !== null && v !== '');
                
                if (values.length === 0) return;
                
                // Check for geographic identifiers
                const firstValue = String(values[0]).trim();
                
                // State detection
                if (colLower.includes('state')) {
                    if (firstValue.length === 2 && /^[A-Z]{2}$/i.test(firstValue)) {
                        analysis.recommendations.push({
                            type: 'state_abbr',
                            column: col,
                            level: 'us_states',
                            confidence: 'high',
                            message: `"${col}" contains 2-letter state abbreviations (e.g., ${values.slice(0,3).join(', ')})`,
                            detail: 'Perfect for state-level choropleth maps'
                        });
                    } else if (/^\d{1,2}$/.test(firstValue)) {
                        analysis.recommendations.push({
                            type: 'state_fips',
                            column: col,
                            level: 'us_states',
                            confidence: 'high',
                            message: `"${col}" contains state FIPS codes (e.g., ${values.slice(0,3).join(', ')})`,
                            detail: 'Standard census codes for US states'
                        });
                    }
                }
                
                // Check for "State_Code" or similar
                if (colLower.includes('state') && colLower.includes('code')) {
                    if (/^\d{1,2}$/.test(firstValue)) {
                        analysis.recommendations.push({
                            type: 'state_fips',
                            column: col,
                            level: 'us_states',
                            confidence: 'very_high',
                            message: `"${col}" contains state FIPS codes (${values.slice(0,3).join(', ')})`,
                            detail: 'These are standard 2-digit state identifiers used by the Census Bureau'
                        });
                    }
                }
                
                // County FIPS detection - be more aggressive with pattern matching
                // Check column name patterns first
                if (colLower.includes('county') && colLower.includes('fips')) {
                    // Column explicitly says "County FIPS" or similar
                    if (/^\d{5}$/.test(firstValue)) {
                        analysis.recommendations.push({
                            type: 'county_fips',
                            column: col,
                            level: 'us_counties',
                            confidence: 'very_high',
                            message: `"${col}" is your county FIPS column (${values.slice(0,3).join(', ')})`,
                            detail: '✅ Perfect! These are 5-digit county FIPS codes.'
                        });
                    } else if (/^\d{4}$/.test(firstValue)) {
                        // 4 digits might be missing leading zero
                        analysis.recommendations.push({
                            type: 'county_fips',
                            column: col,
                            level: 'us_counties',
                            confidence: 'high',
                            message: `"${col}" contains county FIPS (may need padding: ${values.slice(0,3).join(', ')})`,
                            detail: '⚠️ These look like county FIPS but may need a leading zero'
                        });
                    }
                } else if (colLower.includes('county')) {
                    // County-specific column name
                    if (/^\d{5}$/.test(firstValue)) {
                        analysis.recommendations.push({
                            type: 'county_fips',
                            column: col,
                            level: 'us_counties',
                            confidence: 'medium',
                            message: `"${col}" might be county codes (e.g., ${values.slice(0,3).join(', ')})`,
                            detail: 'Column name suggests counties, but verify the data'
                        });
                    }
                } else if (colLower === 'geoid' || colLower === 'geo_id') {
                    // GEOID could be anything - analyze the actual data!
                    if (/^\d{5}$/.test(firstValue)) {
                        // Check if these look like ZIP codes by analyzing prefixes
                        const zipAnalysis = analyzeZipCodes(values.slice(0, 100));
                        
                        if (zipAnalysis.suggestedLevel && zipAnalysis.confidence !== 'low') {
                            // These are ZIP codes!
                            analysis.recommendations.push({
                                type: 'zip',
                                column: col,
                                level: zipAnalysis.suggestedLevel,
                                confidence: 'high',
                                message: `"${col}" contains ZIP codes - ${zipAnalysis.message}`,
                                detail: `✅ GEOID column detected as ZIP codes: ${zipAnalysis.detail}`
                            });
                        } else {
                            // Could be county FIPS
                            analysis.recommendations.push({
                                type: 'county_fips',
                                column: col,
                                level: 'us_counties',
                                confidence: 'low',
                                message: `"${col}" might be county FIPS (${values.slice(0,3).join(', ')})`,
                                detail: 'GEOID could be counties or ZIPs - try both'
                            });
                        }
                    }
                }
                
                // ZIP/ZCTA detection with SMART region analysis
                if (colLower.includes('zip') || colLower.includes('zcta')) {
                    if (/^\d{5}$/.test(firstValue)) {
                        // Analyze which region/state these ZIPs belong to
                        const zipAnalysis = analyzeZipCodes(values);
                        
                        if (zipAnalysis.suggestedLevel) {
                            analysis.recommendations.push({
                                type: 'zip',
                                column: col,
                                level: zipAnalysis.suggestedLevel,
                                confidence: zipAnalysis.confidence,
                                message: `"${col}" contains ZIP codes - ${zipAnalysis.message}`,
                                detail: zipAnalysis.detail
                            });
                        } else {
                            // Fallback if analysis fails
                            analysis.recommendations.push({
                                type: 'zip',
                                column: col,
                                level: 'zctas_northeast',
                                confidence: 'medium',
                                message: `"${col}" contains 5-digit ZIP codes (e.g., ${values.slice(0,3).join(', ')})`,
                                detail: 'Select the appropriate regional ZIP file for your data'
                            });
                        }
                    }
                }
                
                // Generic FIPS detection - ENHANCED with smart analysis
                if (colLower.includes('fips')) {
                    // Column explicitly mentions FIPS
                    if (/^\d+$/.test(firstValue)) {
                        const digitCount = firstValue.length;
                        if (digitCount <= 2) {
                            analysis.recommendations.push({
                                type: 'state_fips',
                                column: col,
                                level: 'us_states',
                                confidence: 'very_high',
                                message: `"${col}" contains ${digitCount}-digit state FIPS (e.g., ${values.slice(0,3).join(', ')})`,
                                detail: '✅ Perfect for state-level maps'
                            });
                        } else if (digitCount === 5) {
                            // FIPS column with 5 digits is almost certainly counties
                            analysis.recommendations.push({
                                type: 'county_fips',
                                column: col,
                                level: 'us_counties',
                                confidence: 'very_high',
                                message: `"${col}" contains 5-digit county FIPS (e.g., ${values.slice(0,3).join(', ')})`,
                                detail: '✅ Perfect for county-level maps!'
                            });
                        }
                    }
                } else if (colLower.includes('code') || colLower.includes('id')) {
                    // More generic - could be anything
                    if (/^\d{5}$/.test(firstValue)) {
                        // Analyze to determine if ZIP or county
                        const zipAnalysis = analyzeZipCodes(values.slice(0, 50));
                        
                        if (zipAnalysis.suggestedLevel && zipAnalysis.confidence !== 'low') {
                            analysis.recommendations.push({
                                type: 'zip',
                                column: col,
                                level: zipAnalysis.suggestedLevel,
                                confidence: 'medium',
                                message: `"${col}" appears to be ZIP codes - ${zipAnalysis.message}`,
                                detail: `🔍 ${zipAnalysis.detail}`
                            });
                        } else {
                            analysis.recommendations.push({
                                type: 'ambiguous_5digit',
                                column: col,
                                level: 'us_counties',
                                confidence: 'low',
                                message: `"${col}" has 5-digit codes (${values.slice(0,3).join(', ')})`,
                                detail: '💡 Could be counties or ZIPs - column name is ambiguous'
                            });
                        }
                    } else if (/^\d{1,2}$/.test(firstValue)) {
                        analysis.recommendations.push({
                            type: 'state_fips',
                            column: col,
                            level: 'us_states',
                            confidence: 'medium',
                            message: `"${col}" might be state codes (e.g., ${values.slice(0,3).join(', ')})`,
                            detail: 'Appears to be state-level identifiers'
                        });
                    }
                }
                
                // FALLBACK: Any 5-digit numeric column could be county FIPS or ZIP
                if (!colLower.includes('zip') && !colLower.includes('county') && !colLower.includes('fips')) {
                    if (/^\d{5}$/.test(firstValue)) {
                        // Check if it looks like ZIP codes based on prefixes
                        const zipAnalysis = analyzeZipCodes(values.slice(0, 100)); // Sample first 100
                        
                        if (zipAnalysis.suggestedLevel && zipAnalysis.confidence !== 'low') {
                            // Looks like ZIP codes based on prefix analysis
                            analysis.recommendations.push({
                                type: 'zip_detected',
                                column: col,
                                level: zipAnalysis.suggestedLevel,
                                confidence: 'medium',
                                message: `"${col}" appears to be ZIP codes - ${zipAnalysis.message}`,
                                detail: `🔍 Auto-detected: ${zipAnalysis.detail}`
                            });
                        } else {
                            // Could be county FIPS or ZIPs
                            analysis.recommendations.push({
                                type: 'generic_5digit',
                                column: col,
                                level: 'us_counties',
                                confidence: 'low',
                                message: `"${col}" has 5-digit codes - could be County FIPS or ZIP (${values.slice(0,3).join(', ')})`,
                                detail: '💡 Try US Counties first, then ZIP codes if that doesn\'t work'
                            });
                        }
                    }
                }
                
                // Check for numeric data columns
                const numericValues = values.map(v => parseFloat(v)).filter(v => !isNaN(v));
                if (numericValues.length > values.length / 2) {
                    analysis.dataColumns.push({
                        column: col,
                        min: Math.min(...numericValues),
                        max: Math.max(...numericValues),
                        count: numericValues.length,
                        sample: numericValues.slice(0, 3).map(v => v.toLocaleString()).join(', ')
                    });
                }
            });
            
            // Sort recommendations by confidence
            analysis.recommendations.sort((a, b) => {
                const confOrder = { very_high: 0, high: 1, medium: 2, low: 3 };
                return (confOrder[a.confidence] || 3) - (confOrder[b.confidence] || 3);
            });
            
            return analysis;
        }
        
        // Process CSV file
        function processCSV(file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showMessage(`CSV parsing error: ${results.errors[0].message}`, 'error');
                        return;
                    }
                    
                    csvData = results.data.filter(row => Object.values(row).some(v => v !== null && v !== ''));
                    
                    if (csvData.length === 0) {
                        showMessage('CSV file is empty', 'error');
                        return;
                    }
                    
                    dropZone.classList.add('has-file');
                    dropZone.innerHTML = `
                        <div class="upload-icon">✅</div>
                        <p style="font-size: 1.1em; font-weight: 600;">File Loaded!</p>
                        <p style="opacity: 0.7; font-size: 0.9em;">${file.name}</p>
                        <p style="color: #00d4ff; font-size: 0.85em; margin-top: 10px;">
                            ${csvData.length} rows • ${Object.keys(csvData[0]).length} columns
                        </p>
                    `;
                    
                    // Analyze CSV and show recommendations
                    const columns = Object.keys(csvData[0]);
                    const analysis = analyzeCSV(csvData, columns);
                    displayAnalysis(analysis);
                    
                    populateControls(analysis);
                    document.getElementById('controlsContainer').style.display = 'block';
                }
            });
        }
        
        // Display analysis results
        function displayAnalysis(analysis) {
            const panel = document.getElementById('analysisPanel');
            const content = document.getElementById('analysisContent');
            
            if (analysis.recommendations.length === 0) {
                content.innerHTML = `
                    <div class="message warning">
                        ⚠️ No geographic columns detected automatically. 
                        Please select your geographic level and ID column manually.
                    </div>
                `;
            } else {
                let html = '';
                
                // Show top recommendation
                const topRec = analysis.recommendations[0];
                html += `
                    <div class="analysis-item recommended" onclick="applyRecommendation('${topRec.level}', '${topRec.column}')">
                        <div class="analysis-label">✅ Recommended: ${topRec.message}</div>
                        <div class="analysis-detail">${topRec.detail}</div>
                        <div class="sample-values">Sample values: ${csvData.slice(0,3).map(r => r[topRec.column]).join(', ')}</div>
                    </div>
                `;
                
                // Show other options if available
                if (analysis.recommendations.length > 1) {
                    html += '<div style="margin-top: 10px; opacity: 0.7; font-size: 0.85em;">Other detected options:</div>';
                    analysis.recommendations.slice(1).forEach(rec => {
                        html += `
                            <div class="analysis-item" onclick="applyRecommendation('${rec.level}', '${rec.column}')">
                                <div class="analysis-label">${rec.message}</div>
                                <div class="analysis-detail">${rec.detail}</div>
                            </div>
                        `;
                    });
                }
                
                content.innerHTML = html;
            }
            
            panel.style.display = 'block';
        }
        
        // Apply recommendation when clicked
        function applyRecommendation(level, column) {
            document.getElementById('geoLevel').value = level;
            document.getElementById('joinColumn').value = column;
            updateGeoLevelHelp();
            checkReadyToCreate();
            showMessage(`Applied recommendation: Using "${column}" with ${level.replace('_', ' ')} boundaries`, 'success');
        }
        
        // Update help text based on selected level
        function updateGeoLevelHelp() {
            const level = document.getElementById('geoLevel').value;
            const helpText = document.getElementById('geoLevelHelp');
            const joinHelp = document.getElementById('joinColumnHelp');
            
            switch(level) {
                case 'us_states':
                    helpText.textContent = 'State-level data for all 50 US states + DC';
                    joinHelp.textContent = 'Use 2-digit state FIPS codes (01, 02...56) or 2-letter abbreviations (AL, AK, etc.)';
                    break;
                case 'us_counties':
                    helpText.textContent = 'County-level data for all 3,000+ US counties';
                    joinHelp.textContent = 'Use 5-digit county FIPS codes (2 state + 3 county, like 01001 for Autauga County, AL)';
                    break;
                default:
                    // Handle ZIP code selections
                    if (level && level.startsWith('zctas_')) {
                        helpText.textContent = 'ZIP code data for the selected region';
                        joinHelp.textContent = 'Use 5-digit ZIP codes (e.g., 10001, 33139, 90210)';
                    } else {
                        helpText.textContent = 'What type of boundaries does your data represent?';
                        joinHelp.textContent = 'Which column contains your geographic identifiers?';
                    }
            }
        }
        
        // Populate control options
        function populateControls(analysis) {
            const columns = Object.keys(csvData[0]);
            
            // Populate join column dropdown
            const joinSelect = document.getElementById('joinColumn');
            joinSelect.innerHTML = '<option value="">Select column...</option>';
            
            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                
                // Mark recommended columns
                const isRecommended = analysis.recommendations.some(r => r.column === col);
                option.textContent = col + (isRecommended ? ' ⭐ Recommended' : '');
                
                joinSelect.appendChild(option);
            });
            
            // Auto-select top recommendation
            if (analysis.recommendations.length > 0) {
                const topRec = analysis.recommendations[0];
                document.getElementById('geoLevel').value = topRec.level;
                joinSelect.value = topRec.column;
                updateGeoLevelHelp();
            }
            
            // Populate data columns
            const dataColumnsDiv = document.getElementById('dataColumns');
            dataColumnsDiv.innerHTML = '';
            
            analysis.dataColumns.forEach(dataCol => {
                const div = document.createElement('div');
                div.className = 'column-item';
                div.innerHTML = `
                    <div style="font-weight: 600;">${dataCol.column}</div>
                    <div style="font-size: 0.75em; opacity: 0.7; margin-top: 4px;">
                        Range: ${dataCol.min.toLocaleString()} - ${dataCol.max.toLocaleString()}
                    </div>
                `;
                div.dataset.column = dataCol.column;
                div.addEventListener('click', () => selectDataColumn(div, dataCol.column));
                dataColumnsDiv.appendChild(div);
            });
            
            if (dataColumnsDiv.children.length === 0) {
                dataColumnsDiv.innerHTML = '<div style="padding: 20px; opacity: 0.6;">No numeric columns found</div>';
            }
            
            checkReadyToCreate();
        }
        
        // Select data column
        function selectDataColumn(element, column) {
            document.querySelectorAll('.column-item').forEach(item => {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedDataColumn = column;
            checkReadyToCreate();
        }
        
        // Check if ready to create map
        function checkReadyToCreate() {
            const geoLevel = document.getElementById('geoLevel').value;
            const joinColumn = document.getElementById('joinColumn').value;
            const createBtn = document.getElementById('createMapBtn');
            
            createBtn.disabled = !(geoLevel && joinColumn && selectedDataColumn);
        }
        
        // Event listeners
        document.getElementById('geoLevel').addEventListener('change', () => {
            updateGeoLevelHelp();
            checkReadyToCreate();
        });
        document.getElementById('joinColumn').addEventListener('change', checkReadyToCreate);
        document.getElementById('createMapBtn').addEventListener('click', createChoropleth);
        
        // Create choropleth map
        async function createChoropleth() {
            const geoLevel = document.getElementById('geoLevel').value;
            const joinColumn = document.getElementById('joinColumn').value;
            const quality = document.querySelector('input[name="quality"]:checked')?.value || 'fast';
            const mapTitle = document.getElementById('mapTitle').value;
            const dataUnits = document.getElementById('dataUnits').value;
            
            showMessage('Creating your choropleth map...', 'info');
            
            try {
                // Determine which boundaries to load based on quality setting
                let boundaryPath, boundaryInfo;
                
                // Check if this is a ZIP code layer  
                if (geoLevel.startsWith('zctas_')) {
                    boundaryInfo = metadata.boundaries[geoLevel];
                    if (boundaryInfo) {
                        // Regional ZIP codes are in boundaries_regional folder
                        boundaryPath = `boundaries_regional/${boundaryInfo.file}`;
                    }
                } else if (quality === 'hq' && metadata.hq) {
                    // Use high quality boundaries for states/counties
                    boundaryInfo = metadata.hq.boundaries[geoLevel];
                    if (boundaryInfo) {
                        boundaryPath = `boundaries_hq/${boundaryInfo.file}`;
                    }
                }
                
                // Fall back to regular boundaries
                if (!boundaryPath) {
                    boundaryInfo = metadata.boundaries[geoLevel];
                    boundaryPath = `boundaries/${boundaryInfo.file}`;
                }
                
                // Load boundary data if not cached
                const cacheKey = `${geoLevel}_${quality}`;
                if (!boundaries[cacheKey]) {
                    showMessage(`Loading ${quality === 'hq' ? 'high quality' : 'optimized'} boundaries...`, 'info');
                    const response = await fetch(boundaryPath);
                    if (!response.ok) throw new Error('Failed to load boundaries');
                    boundaries[cacheKey] = await response.json();
                }
                
                const boundaryData = boundaries[cacheKey];
                const idField = boundaryInfo.id_field;
                
                // Create lookup for CSV data
                csvLookup = {};
                let matchCount = 0;
                
                csvData.forEach(row => {
                    const rawKey = row[joinColumn];
                    if (rawKey === null || rawKey === undefined) return;
                    
                    let key = String(rawKey).trim();
                    
                    // Handle FIPS padding
                    if (/^\d+$/.test(key)) {
                        if (geoLevel === 'us_states') {
                            key = key.padStart(2, '0');
                        } else if (geoLevel === 'us_counties') {
                            key = key.padStart(5, '0');
                        }
                    }
                    
                    const value = parseFloat(row[selectedDataColumn]);
                    if (!isNaN(value)) {
                        csvLookup[key] = value;
                        csvLookup[key.toUpperCase()] = value;
                        csvLookup[key.toLowerCase()] = value;
                    }
                });
                
                // Calculate statistics
                const values = Object.values(csvLookup);
                const uniqueValues = [...new Set(values)];
                const minValue = Math.min(...uniqueValues);
                const maxValue = Math.max(...uniqueValues);
                
                // Create color scale
                const colorScale = chroma.scale(['#ffffcc', '#a1dab4', '#41b6c4', '#2c7fb8', '#253494'])
                    .domain([minValue, maxValue]);
                
                // Clear existing layer
                if (currentLayer) {
                    map.removeLayer(currentLayer);
                }
                
                // Create new layer
                let featuresWithData = [];
                currentLayer = L.geoJSON(boundaryData, {
                    style: function(feature) {
                        const id = feature.properties[idField];
                        const value = csvLookup[id] || csvLookup[String(id).toUpperCase()] || csvLookup[String(id).toLowerCase()];
                        
                        if (value !== undefined) {
                            matchCount++;
                            featuresWithData.push(feature);
                            return {
                                fillColor: colorScale(value).hex(),
                                fillOpacity: 0.8,
                                weight: 1,
                                color: '#333',
                                opacity: 0.8
                            };
                        } else {
                            return {
                                fillColor: '#666',
                                fillOpacity: 0.3,
                                weight: 1,
                                color: '#333',
                                opacity: 0.5
                            };
                        }
                    },
                    onEachFeature: function(feature, layer) {
                        const id = feature.properties[idField];
                        const value = csvLookup[id] || csvLookup[String(id).toUpperCase()];
                        const name = feature.properties.NAME || feature.properties.ABBR || id;
                        
                        let popup = `<strong>${name}</strong><br>`;
                        if (value !== undefined) {
                            popup += `${selectedDataColumn}: ${value.toLocaleString()}`;
                        } else {
                            popup += `No data available`;
                        }
                        layer.bindPopup(popup);
                    }
                }).addTo(map);
                
                // Store current GeoJSON for export
                currentGeoJSON = boundaryData;
                
                // Zoom to data extent
                if (featuresWithData.length > 0) {
                    const bounds = L.geoJSON({
                        type: 'FeatureCollection',
                        features: featuresWithData
                    }).getBounds();
                    map.fitBounds(bounds.pad(0.1));
                }
                
                // Create legend with title and units
                createLegend(minValue, maxValue, colorScale, mapTitle, dataUnits);
                
                // Update stats
                document.getElementById('statFeatures').textContent = boundaryData.features.length;
                document.getElementById('statMatched').textContent = `${matchCount} / ${Object.keys(csvLookup).length / 3}`;
                document.getElementById('statRange').textContent = `${minValue.toLocaleString()} - ${maxValue.toLocaleString()}`;
                document.getElementById('statsBox').style.display = 'block';
                
                // Show export button prominently
                document.getElementById('exportBtn').style.display = 'block';
                document.getElementById('exportBtn').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                showMessage(`Success! Created choropleth with ${matchCount} matched features.`, 'success');
                
            } catch (error) {
                showMessage(`Error creating map: ${error.message}`, 'error');
            }
        }
        
        // Create legend
        function createLegend(minValue, maxValue, colorScale, mapTitle, dataUnits) {
            if (currentLegend) {
                map.removeControl(currentLegend);
            }
            
            currentLegend = L.control({position: 'bottomright'});
            
            currentLegend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                const range = maxValue - minValue;
                const steps = 5;
                
                // Add map title if provided
                if (mapTitle) {
                    div.innerHTML = `<h2 style="font-size: 1.1em; margin-bottom: 10px; color: #fff;">${mapTitle}</h2>`;
                }
                
                // Add column name and units
                const unitsText = dataUnits ? ` (${dataUnits})` : '';
                div.innerHTML += `<h3>${selectedDataColumn}${unitsText}</h3>`;
                
                // Smart number formatting function
                function formatLegendNumber(value, range) {
                    // For percentages or rates (0-1 or 0-100 range)
                    if (value >= 0 && value <= 1 && range <= 1) {
                        return (value * 100).toFixed(1) + '%';
                    } else if (value >= 0 && value <= 100 && dataUnits && dataUnits.toLowerCase().includes('%')) {
                        return value.toFixed(1) + '%';
                    }
                    
                    // For very large numbers (millions, billions)
                    if (value >= 1000000000) {
                        return (value / 1000000000).toFixed(1) + 'B';
                    } else if (value >= 1000000) {
                        return (value / 1000000).toFixed(1) + 'M';
                    } else if (value >= 100000) {
                        return (value / 1000).toFixed(0) + 'K';
                    } else if (value >= 10000) {
                        return (value / 1000).toFixed(1) + 'K';
                    }
                    
                    // For whole numbers
                    if (Number.isInteger(value) || range > 100) {
                        return Math.round(value).toLocaleString();
                    }
                    
                    // For decimals - use appropriate precision
                    if (range < 0.1) {
                        return value.toFixed(3);
                    } else if (range < 1) {
                        return value.toFixed(2);
                    } else if (range < 10) {
                        return value.toFixed(1);
                    } else {
                        return Math.round(value).toLocaleString();
                    }
                }
                
                // Create color scale items
                for (let i = 0; i < steps; i++) {
                    const value = minValue + (range * i / (steps - 1));
                    const color = colorScale(value).hex();
                    const label = formatLegendNumber(value, range);
                    
                    div.innerHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${color}"></div>
                            <span>${label}</span>
                        </div>
                    `;
                }
                
                return div;
            };
            
            currentLegend.addTo(map);
        }
        
        // Export to ArcGIS
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (!currentGeoJSON || !csvLookup) {
                showMessage('No map to export', 'error');
                return;
            }
            
            // Add CSV data to GeoJSON properties
            const exportGeoJSON = JSON.parse(JSON.stringify(currentGeoJSON));
            const idField = metadata.boundaries[document.getElementById('geoLevel').value].id_field;
            
            exportGeoJSON.features.forEach(feature => {
                const id = feature.properties[idField];
                const value = csvLookup[id] || csvLookup[String(id).toUpperCase()];
                
                if (value !== undefined) {
                    feature.properties[selectedDataColumn] = value;
                }
            });
            
            // Download
            const blob = new Blob([JSON.stringify(exportGeoJSON, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `choropleth_${selectedDataColumn}_${new Date().getTime()}.geojson`;
            a.click();
            
            showMessage('GeoJSON exported! Upload to ArcGIS Online to use in your maps.', 'success');
        });
        
        // Show message
        function showMessage(text, type) {
            const container = document.getElementById('messageContainer');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            container.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 5000);
        }
        
        // Initialize
        loadMetadata();
    </script>
</body>
</html>